{% extends 'attendance/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<style>
    /* Global styles */
    .container-fluid {
        padding: 2rem;
    }

    /* Card styles */
    .card-lg {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
        transition: all 0.3s ease;
    }

    .card-lg:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }

    .card-header {
        background: linear-gradient(135deg, #fff0f5 0%, #ff69b4 100%);
        border-bottom: 2px solid #ff69b4;
        padding: 1.5rem;
        border-radius: 15px 15px 0 0;
        box-shadow: inset 0 -2px 0 rgba(0, 0, 0, 0.05);
    }

    .card-header h3, .card-header h5 {
        font-weight: 700;
        color: #ffffff;
        margin-bottom: 0;
        font-size: 1.75rem;
        line-height: 1.4;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        letter-spacing: 0.5px;
    }

    .card-header:hover {
        background: linear-gradient(135deg, #ff69b4 0%, #fff0f5 100%);
        border-bottom-color: #ff69b4;
    }

    .card-body {
        padding: 2rem;
        background: white;
        font-size: 1.1rem;
        line-height: 1.6;
        color: #333;
    }

    /* Button styles */
    .btn-group {
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Child-friendly button styles */
    .btn-primary {
        background-color: #4ecdc4;
        border-color: #4ecdc4;
        box-shadow: 0 4px 10px rgba(78,205,196,0.3);
        padding: 1rem 2rem;
        font-size: 1.1rem;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        background-color: #45b7d1;
        border-color: #45b7d1;
        box-shadow: 0 6px 15px rgba(78,205,196,0.4);
        transform: translateY(-2px);
    }

    .btn-outline-danger {
        color: #ff6b6b;
        border-color: #ff6b6b;
        background: none;
        padding: 1rem 2rem;
        font-size: 1.1rem;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .btn-outline-danger:hover {
        background-color: #ff6b6b;
        color: white;
        transform: translateY(-2px);
    }

    /* Make buttons more prominent on tablet */
    @media (max-width: 992px) {
        .btn-primary, .btn-outline-danger {
            padding: 1.25rem 2.5rem;
            font-size: 1.25rem;
        }
    }

    /* Card styles */
    .card-lg {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
        transition: all 0.3s ease;
    }

    .card-lg:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .card-header {
        background-color: #f8f9fa;
        border-bottom: 2px solid #e9ecef;
        padding: 1.5rem;
        border-radius: 15px 15px 0 0;
    }

    .card-header h3, .card-header h5 {
        font-weight: 600;
        color: #212529;
        margin-bottom: 0;
        font-size: 1.5rem;
    }

    .card-body {
        padding: 2rem;
    }

    /* Hide extra sign in/out buttons in Childcare Attendance form */
    .card-header .btn-group {
        display: none;
    }

    /* Tablet-specific card adjustments */
    @media (max-width: 992px) {
        .card-lg {
            margin-bottom: 2.5rem;
        }

        .card-header {
            padding: 1.25rem;
        }

        .card-body {
            padding: 1.5rem;
        }
    }

    /* Search container */
    .search-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 1.5rem;
    }

    .search-container input {
        padding: 1rem 1.5rem;
        font-size: 1.1rem;
        border-radius: 10px;
        border: 2px solid #e2e8f0;
    }

    .search-container .form-control:focus {
        z-index: 2;
    }

    /* Tablet-specific search adjustments */
    @media (max-width: 992px) {
        .search-container {
            padding: 1.75rem;
            margin-bottom: 2rem;
        }

        .search-container input {
            padding: 1.25rem 1.75rem;
            font-size: 1.25rem;
        }
    }
        font-size: 0.95rem;
        width: 100%;
        transition: all 0.2s ease;
    }

    .search-container {
        position: relative;
        margin-bottom: 1rem;
    }

    .search-container .form-control:focus {
        z-index: 2;
    }

    #searchResults {
        position: relative;
        margin-top: 0.5rem;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        max-height: 300px;
        overflow-y: auto;
        display: none;
        z-index: 9999;
    }

    #searchResults.show {
        display: block;
    }

    .list-group-item {
        border: none;
        padding: 0.75rem 1rem;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .list-group-item:hover {
        background-color: #f8f9fa;
    }

    /* Search container layout */
    .search-container {
        position: relative;
        margin-bottom: 2rem;
    }

    .search-container .form-control:focus {
        z-index: 2;
    }

    .form-control:focus {
        border-color: #4ecdc4;
        box-shadow: 0 0 0 3px rgba(78,205,196,0.2);
    }

    /* Tablet-specific form adjustments */
    @media (max-width: 992px) {
        .form-label {
            font-size: 1.25rem;
            margin-bottom: 1.25rem;
        }

        .form-control {
            padding: 1.25rem 1.75rem;
            font-size: 1.25rem;
            min-height: 56px;
        }
    }

    /* Make profile picture more prominent */
    #profilePicture {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 50%;
        margin-right: 1.5rem;
    }

    /* Tablet-specific profile picture adjustments */
    @media (max-width: 992px) {
        #profilePicture {
            width: 140px;
            height: 140px;
            margin-right: 2rem;
        }
    }
    }

    .form-control:focus {
        border-color: #4ecdc4;
        box-shadow: 0 0 0 0.25rem rgba(78,205,196,0.25);
    }

    textarea.form-control {
        resize: vertical;
        min-height: 100px;
    }

    /* Status indicators */
    .attendance-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .attendance-status i {
        font-size: 0.75rem;
    }

    /* Schedule card */
    .today-schedule-card {
        margin-top: 2rem;
    }

    .list-group-flush .list-group-item {
        border-left: none;
        border-right: none;
        border-top: none;
        border-bottom: 1px solid #e9ecef;
        padding: 0.75rem;
    }

    .list-group-flush .list-group-item:last-child {
        border-bottom: none;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .card-lg {
            margin-bottom: 1.5rem;
        }

        .btn-group {
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .list-group-item {
            padding: 0.75rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-6" id="left_card">
            <div class="card card-lg">
                <div class="card-header">
                    <h3 class="card-title mb-0">Search for Child</h3>
                </div>
                <div class="card-body">
                    <div class="search-container">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="searchInput" placeholder="Search by child or parent name...">
                            <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="searchResults" class="list-group"></div>
                    </div>
                    
                    <script>
                    // Clear search button functionality
                    document.addEventListener('DOMContentLoaded', function() {
                        const clearSearch = document.getElementById('clearSearch');
                        const searchInput = document.getElementById('searchInput');
                        
                        if (clearSearch && searchInput) {
                            clearSearch.addEventListener('click', function() {
                                searchInput.value = '';
                                searchInput.dispatchEvent(new Event('input'));
                            });
                            
                            searchInput.addEventListener('input', function() {
                                clearSearch.style.display = this.value ? 'block' : 'none';
                            });
                            
                            // Hide results when clicking outside
                            document.addEventListener('click', function(e) {
                                if (!e.target.closest('.search-container')) {
                                    const searchResults = document.getElementById('searchResults');
                                    if (searchResults) {
                                        searchResults.style.display = 'none';
                                    }
                                }
                            });
                        }
                    });
                    </script>
                </div>
            </div>
            <div class="card card-lg mt-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">Today's Schedule</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item">
                            <h6 class="mb-1">Operating Hours</h6>
                            <small class="text-muted">7:30 AM - 6:00 PM</small>
                        </div>
                        <div class="list-group-item">
                            <h6 class="mb-1">Breakfast</h6>
                            <small class="text-muted">8:00 AM - 9:00 AM</small>
                        </div>
                        <div class="list-group-item">
                            <h6 class="mb-1">Lunch</h6>
                            <small class="text-muted">11:30 AM - 12:30 PM</small>
                        </div>
                        <div class="list-group-item">
                            <h6 class="mb-1">Nap Time</h6>
                            <small class="text-muted">1:00 PM - 3:00 PM</small>
                        </div>
                        <div class="list-group-item">
                            <h6 class="mb-1">Snack Time</h6>
                            <small class="text-muted">3:30 PM - 4:00 PM</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6" id="right_card">
            <div class="card card-lg">
                <div class="card-header">
                    <h3 class="card-title mb-0">Attendance Form</h3>
                </div>
                <div class="card-body">
                    <form id="attendanceForm" method="post" action="{% url 'attendance:dashboard' %}">
                        {% csrf_token %}
                        <input type="hidden" name="child_id" id="selectedChildId">
                        <input type="hidden" name="action" id="attendanceAction">
                        <input type="hidden" name="notes" id="attendanceNotes">
                        <div class="mb-3">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <img id="profilePicture" src="{% static 'images/child_pix/user-default.png' %}" alt="Child Profile" class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover;">
                                </div>
                                <div>
                                    <label class="form-label">Child</label>
                                    <input type="text" class="form-control" id="childName" placeholder="Select a child" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Center</label>
                            <input type="text" class="form-control" id="centerName" name="center_name" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Parent</label>
                            <input type="text" class="form-control" id="parentName" placeholder="Parent will appear when child is selected" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <p id="attendanceStatus" class="form-control-plaintext"></p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" id="attendanceNotes" name="notes" rows="3"></textarea>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary flex-grow-1" id="signInButton" title="">Sign In</button>
                            <button type="submit" class="btn btn-danger flex-grow-1" id="signOutButton" title="Child must be signed in first">Sign Out</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
// Helper function to escape HTML
function escapeHtml(unsafe) {
    if (unsafe === undefined || unsafe === null) {
        return '';
    }
    return unsafe
        .toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// Function to automatically dismiss messages after 5 seconds
function autoDismissMessages() {
    const messages = document.querySelectorAll('.alert');
    messages.forEach(msg => {
        // Check if the message is new (not dismissed)
        if (!msg.classList.contains('alert-dismissed')) {
            msg.classList.add('alert-dismissed');
            setTimeout(() => {
                msg.remove();
            }, 5000);
        }
    });
}

// Call the function when the page loads and whenever new messages appear
// Only clear alerts if they exist
const clearAlerts = () => {
    const alerts = document.querySelectorAll('.alert');
    if (alerts.length > 0) {
        alerts.forEach(alert => {
            alert.remove();
        });
    }
};

// Clear alerts after 5 seconds
setTimeout(clearAlerts, 5000);

// Update clock and date
document.addEventListener('DOMContentLoaded', updateClock);

function updateClock() {
    const timeElement = document.getElementById('clock-time');
    const dateElement = document.getElementById('clock-date');
    
    const now = new Date();
    const hours = now.getHours();
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    
    // Format time as 12-hour with AM/PM
    const formattedTime = `${hours % 12 || 12}:${minutes}:${seconds} ${hours >= 12 ? 'PM' : 'AM'}`;
    
    // Format date as Month, Day Year with comma
    const options = { month: 'long', day: 'numeric', year: 'numeric' };
    const formattedDate = now.toLocaleDateString('en-US', options).replace(/,/g, '');
    
    if (timeElement) {
        timeElement.textContent = formattedTime;
    }
    if (dateElement) {
        dateElement.textContent = formattedDate;
    }
    
    // Update every second
    setTimeout(updateClock, 1000);
}

// Also listen for new messages being added
const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
        if (mutation.addedNodes.length) {
            mutation.addedNodes.forEach(function(node) {
                if (node.classList && node.classList.contains('alert')) {
                    // Only dismiss if it's a new alert
                    if (!node.classList.contains('alert-dismissed')) {
                        autoDismissMessages();
                    }
                }
            });
        }
    });
});

// Start observing the body for new alerts
observer.observe(document.body, { childList: true, subtree: true });

// Global function for selecting a child
function selectChild(id, childName, parentName, centerName) {
    // Check if child is already signed in for today
    fetch(`{% url 'attendance:check_sign_in' %}?child_id=${id}`)
        .then(response => response.json())
        .then(data => {
            // Clear any existing selected child
            const selectedChildId = document.getElementById('selectedChildId');
            if (selectedChildId) {
                selectedChildId.value = id;
            }
            
            // Update form fields
            const childNameInput = document.getElementById('childName');
            const parentNameInput = document.getElementById('parentName');
            const centerNameInput = document.getElementById('centerName');
            
            if (childNameInput) childNameInput.value = childName;
            if (parentNameInput) parentNameInput.value = parentName;
            if (centerNameInput) centerNameInput.value = centerName;

            // Show success message
            const messageDiv = document.createElement('div');
            messageDiv.className = 'alert alert-success alert-dismissible fade show';
            messageDiv.innerHTML = `
                <strong>${childName}</strong> selected successfully.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const messagesContainer = document.getElementById('messages');
            if (messagesContainer) {
                messagesContainer.innerHTML = '';
                messagesContainer.appendChild(messageDiv);
            }

            // Clear search input and results
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
                const searchResults = document.getElementById('searchResults');
                if (searchResults) {
                    searchResults.innerHTML = '';
                }
            }

            // Disable/enable sign in button based on check_sign_in response
            const signInButton = document.getElementById('signInButton');
            const signOutButton = document.getElementById('signOutButton');
            
            if (signInButton && signOutButton) {
                if (data.already_signed_in) {
                    // If already signed in
                    signInButton.disabled = true;
                    signInButton.title = `Already signed in at ${data.sign_in_time}`;
                    signOutButton.disabled = false;
                    signOutButton.title = '';
                } else {
                    // If not signed in
                    signInButton.disabled = false;
                    signInButton.title = '';
                    signOutButton.disabled = false;  // Keep sign out button enabled
                    signOutButton.title = 'Child must be signed in first';
                }
            }
        })
        .catch(error => {
            console.error('Error checking sign-in status:', error);
            alert('Error checking sign-in status. Please try again.');
        });
}

// Initialize search functionality
document.addEventListener('DOMContentLoaded', function() {
    // Initialize elements
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const form = document.getElementById('attendanceForm');
    const loadingIndicator = document.createElement('div');
    loadingIndicator.className = 'text-center mb-3';
    loadingIndicator.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';

    // Handle form submission
    form.addEventListener('submit', function(e) {
        const actionInput = document.getElementById('attendanceAction');
        const submitButton = e.submitter;
        const selectedChildId = document.getElementById('selectedChildId');
        
        // Prevent submission if no child is selected
        if (!selectedChildId.value) {
            e.preventDefault();
            alert('Please select a child first');
            return;
        }

        // Check button type and handle accordingly
        if (submitButton) {
            if (submitButton.id === 'signOutButton') {
                // For sign out, check if child is signed in
                fetch(`{% url 'attendance:check_sign_in' %}?child_id=${selectedChildId.value}`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data.already_signed_in) {
                            alert('Child must be signed in to sign out');
                            return;
                        }
                        
                        // If signed in, proceed with sign out
                        actionInput.value = 'sign_out';
                        form.submit();
                    })
                    .catch(error => {
                        console.error('Error checking sign-out status:', error);
                        alert('Error checking sign-out status. Please try again.');
                    });
                
                // Prevent default submission while we check
                e.preventDefault();
                return;
            }
            
            if (submitButton.id === 'signInButton') {
                // For sign in, check if child is already signed in
                fetch(`{% url 'attendance:check_sign_in' %}?child_id=${selectedChildId.value}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.already_signed_in) {
                            alert(`Child is already signed in today at ${data.sign_in_time}`);
                            return;
                        }
                        
                        // If not signed in, proceed with submission
                        actionInput.value = 'sign_in';
                        form.submit();
                    })
                    .catch(error => {
                        console.error('Error checking sign-in status:', error);
                        alert('Error checking sign-in status. Please try again.');
                    });
                
                // Prevent default submission while we check
                e.preventDefault();
                return;
            }
        }
        
        // If we got here, prevent default submission
        e.preventDefault();
        alert('Please select either Sign In or Sign Out');
    });

    // Search functionality
    searchInput.addEventListener('input', async function() {
        const searchTerm = this.value.trim();
        
        // Clear the parent input box when search starts
        const parentNameInput = document.getElementById('parentName');
        if (parentNameInput) {
            parentNameInput.value = '';
        }
        
        // Only search if term is at least 2 characters
        if (searchTerm.length >= 2) {
            searchResults.innerHTML = '';
            
            try {
                const response = await fetch(`{% url 'attendance:search_children' %}?q=${encodeURIComponent(searchTerm)}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!Array.isArray(data)) {
                    throw new Error('Invalid response format');
                }
                
                if (data.length === 0) {
                    searchResults.innerHTML = '<div class="list-group-item text-muted">No results found</div>';
                    return;
                }
                
                data.forEach(child => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item clickable-search-item';
                    
                    // Escape HTML content
                    const escapedName = escapeHtml(child.name);
                    const escapedParent = escapeHtml(child.parent);
                    const escapedCenter = escapeHtml(child.center);
                    
                    item.innerHTML = `
                        <div class="d-flex align-items-center">
                            <div>
                                <h6 class="mb-0">${escapedName}</h6>
                                <small class="text-muted">${escapedParent}</small>
                                <small class="text-muted d-block">${escapedCenter}</small>
                            </div>
                        </div>
                    `;
                    
                    item.addEventListener('click', () => {
                        selectChild(child.id, escapedName, escapedParent, escapedCenter);
                    });
                    
                    searchResults.appendChild(item);
                });
                
                searchResults.classList.add('show');
            } catch (error) {
                console.error('Search error:', error);
                searchResults.innerHTML = '<div class="list-group-item text-danger">Error searching for children</div>';
            }
        } else {
            searchResults.innerHTML = '';
            searchResults.classList.remove('show');
        }
    });

    // Hide results when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-container')) {
            searchResults.classList.remove('show');
        }
    });

    // Show results when hovering over the search container
    const searchContainer = document.querySelector('.search-container');
    const resultsElement = document.getElementById('searchResults');
    
    if (searchContainer && resultsElement) {
        const container = searchContainer.closest('.card');
        
        // Add hover events to both container and results
        const elementsToWatch = [container, resultsElement];
        
        elementsToWatch.forEach(element => {
            element.addEventListener('mouseenter', () => {
                if (resultsElement.innerHTML.trim()) {
                    resultsElement.classList.add('show');
                }
            });
        });
        
        // Add mouseleave to both elements
        elementsToWatch.forEach(element => {
            element.addEventListener('mouseleave', (e) => {
                // Check if the mouse is moving to/from the other element
                const relatedTarget = e.relatedTarget;
                if (!relatedTarget || 
                    (!elementsToWatch.includes(relatedTarget) && 
                     !resultsElement.contains(relatedTarget))) {
                    resultsElement.classList.remove('show');
                }
            });
        });
    }

    // Add keyboard navigation
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            searchInput.value = '';
            searchInput.dispatchEvent(new Event('input'));
        }
    });

    // Adjust card height when search results are shown/hidden
    const rightCard = document.getElementById('right_card');
    if (rightCard) {
        searchResults.addEventListener('transitionend', () => {
            if (searchResults.classList.contains('show')) {
                // Adjust positioning using absolute positioning
                searchResults.style.position = 'absolute';
                searchResults.style.top = '100%';
                searchResults.style.left = '0';
                searchResults.style.width = '100%';
                searchResults.style.maxHeight = '300px';
                searchResults.style.overflowY = 'auto';
                searchResults.style.borderRadius = '0 0 12px 12px';
                searchResults.style.zIndex = '1000';
            } else {
                // Reset positioning when results are hidden
                searchResults.style.position = 'static';
                searchResults.style.maxHeight = 'none';
                searchResults.style.overflowY = 'visible';
            }
        });
    }
});
</script>
{% endblock %}
