{% extends 'attendance/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<style>
    /* Global styles */
    .container-fluid {
        padding: 2rem 1rem;
    }

    /* Card styles */
    .card-lg {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        margin-bottom: 2rem;
    }

    .card-lg:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 12px rgba(0, 0, 0, 0.1);
    }

    .card-header {
        background-color: #f8f9fa;
        border-bottom: 2px solid #e9ecef;
        padding: 1.5rem;
        border-radius: 15px 15px 0 0;
    }

    .card-header h3, .card-header h5 {
        font-weight: 600;
        color: #212529;
        margin-bottom: 0;
    }

    .card-body {
        padding: 2rem;
        background: white;
    }

    /* Button styles */
    .btn-group {
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-primary {
        background-color: #4ecdc4;
        border-color: #4ecdc4;
        box-shadow: 0 4px 15px rgba(78,205,196,0.3);
    }

    .btn-primary:hover {
        background-color: #45b7d1;
        border-color: #45b7d1;
        box-shadow: 0 6px 20px rgba(78,205,196,0.4);
    }

    .btn-outline-danger {
        color: #ff6b6b;
        border-color: #ff6b6b;
        background: none;
    }

    .btn-outline-danger:hover {
        background-color: #ff6b6b;
        color: white;
    }

    /* Hide extra sign in/out buttons in Childcare Attendance form */
    .card-header .btn-group {
        display: none;
    }

    /* Search container */
    .search-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .search-container input {
        padding: 0.75rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1rem;
        width: 100%;
        transition: all 0.3s ease;
    }

    .search-container input:focus {
        border-color: #4ecdc4;
        box-shadow: 0 0 0 0.25rem rgba(78,205,196,0.25);
    }

    /* Search results */
    .list-group {
        border-radius: 8px;
        overflow: hidden;
        margin-top: 1rem;
        max-height: 300px;
        overflow-y: auto;
    }

    .list-group-item {
        border: none;
        padding: 1rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .list-group-item:hover {
        background-color: #f3f4f6;
    }

    .list-group-item img {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 50%;
    }

    /* Form styles */
    .form-label {
        font-weight: 500;
        color: #475569;
        margin-bottom: 0.5rem;
    }

    .form-control {
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        transition: all 0.3s ease;
        width: 100%;
    }

    .form-control:focus {
        border-color: #4ecdc4;
        box-shadow: 0 0 0 0.25rem rgba(78,205,196,0.25);
    }

    textarea.form-control {
        resize: vertical;
        min-height: 100px;
    }

    /* Status indicators */
    .attendance-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .attendance-status i {
        font-size: 0.75rem;
    }

    /* Schedule card */
    .today-schedule-card {
        margin-top: 2rem;
    }

    .list-group-flush .list-group-item {
        border-left: none;
        border-right: none;
        border-top: none;
        border-bottom: 2px solid #e9ecef;
    }

    .list-group-flush .list-group-item:last-child {
        border-bottom: none;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .card-lg {
            margin-bottom: 1.5rem;
        }

        .btn-group {
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .list-group-item {
            padding: 0.75rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card card-lg">
                <div class="card-header">
                    <h3 class="card-title mb-0">Childcare Attendance</h3>
                </div>
                <div class="card-body">
                    <div class="search-container">
                        <input type="text" class="form-control" id="searchInput" placeholder="Search children...">
                        <div id="searchResults" class="list-group"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card card-lg">
                <div class="card-header">
                    <h3 class="card-title mb-0">Attendance Form</h3>
                </div>
                <div class="card-body">
                    <form id="attendanceForm" method="post" action="{% url 'attendance:dashboard' %}">
                        {% csrf_token %}
                        <input type="hidden" name="child_id" id="selectedChildId">
                        <input type="hidden" name="action" id="attendanceAction">
                        <input type="hidden" name="notes" id="attendanceNotes">
                        <div class="mb-3">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <img id="profilePicture" src="/static/images/child_pix/user-default.png" alt="Child Profile" class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover;">
                                </div>
                                <div>
                                    <label class="form-label">Child</label>
                                    <input type="text" class="form-control" id="childName" placeholder="Select a child" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Parent</label>
                            <input type="text" class="form-control" id="parentName" placeholder="Parent will appear when child is selected" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <p id="attendanceStatus" class="form-control-plaintext"></p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" id="attendanceNotes" name="notes" rows="3"></textarea>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary" id="signInButton" disabled>Sign In</button>
                            <button type="submit" class="btn btn-outline-danger" id="signOutButton" disabled>Sign Out</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card card-lg today-schedule-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Today's Schedule</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item">
                            <h6 class="mb-1">Operating Hours</h6>
                            <small class="text-muted">7:30 AM - 6:00 PM</small>
                        </div>
                        <div class="list-group-item">
                            <h6 class="mb-1">Breakfast</h6>
                            <small class="text-muted">8:00 AM - 9:00 AM</small>
                        </div>
                        <div class="list-group-item">
                            <h6 class="mb-1">Lunch</h6>
                            <small class="text-muted">11:30 AM - 12:30 PM</small>
                        </div>
                        <div class="list-group-item">
                            <h6 class="mb-1">Nap Time</h6>
                            <small class="text-muted">1:00 PM - 3:00 PM</small>
                        </div>
                        <div class="list-group-item">
                            <h6 class="mb-1">Snack Time</h6>
                            <small class="text-muted">3:30 PM - 4:00 PM</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

                <!-- Currently Signed In Children -->
                <div class="mt-4">
                    <h5>Currently Signed In Children</h5>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Child Name</th>
                                    <th>Parent Name</th>
                                    <th>Sign In Time</th>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Function to automatically dismiss messages after 5 seconds
function autoDismissMessages() {
    const messages = document.querySelectorAll('.alert');
    messages.forEach(msg => {
        // Check if the message is new (not dismissed)
        if (!msg.classList.contains('alert-dismissed')) {
            msg.classList.add('alert-dismissed');
            setTimeout(() => {
                msg.remove();
            }, 5000);
        }
    });
}

// Call the function when the page loads and whenever new messages appear
// Only clear alerts if they exist
const clearAlerts = () => {
    const alerts = document.querySelectorAll('.alert');
    if (alerts.length > 0) {
        alerts.forEach(alert => {
            alert.remove();
        });
    }
};

// Clear alerts after 5 seconds
setTimeout(clearAlerts, 5000);

// Update clock and date
document.addEventListener('DOMContentLoaded', updateClock);

function updateClock() {
    const timeElement = document.getElementById('clock-time');
    const dateElement = document.getElementById('clock-date');
    
    const now = new Date();
    const hours = now.getHours();
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    
    // Format time as 12-hour with AM/PM
    const formattedTime = `${hours % 12 || 12}:${minutes}:${seconds} ${hours >= 12 ? 'PM' : 'AM'}`;
    
    // Format date as Month, Day Year with comma
    const options = { month: 'long', day: 'numeric', year: 'numeric' };
    const formattedDate = now.toLocaleDateString('en-US', options).replace(/,/g, '');
    
    if (timeElement) {
        timeElement.textContent = formattedTime;
    }
    if (dateElement) {
        dateElement.textContent = formattedDate;
    }
    
    // Update every second
    setTimeout(updateClock, 1000);
}

// Also listen for new messages being added
const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
        if (mutation.addedNodes.length) {
            mutation.addedNodes.forEach(function(node) {
                if (node.classList && node.classList.contains('alert')) {
                    // Only dismiss if it's a new alert
                    if (!node.classList.contains('alert-dismissed')) {
                        autoDismissMessages();
                    }
                }
            });
        }
    });
});

// Start observing the body for new alerts
observer.observe(document.body, { childList: true, subtree: true });

// Global function for selecting a child
function selectChild(id, childName, parentName) {
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const selectedChildId = document.getElementById('selectedChildId');
    const parentNameInput = document.getElementById('parentName');
    const childNameInput = document.getElementById('childName');
    const signInButton = document.getElementById('signInButton');
    const signOutButton = document.getElementById('signOutButton');
    const attendanceNotes = document.getElementById('attendanceNotes');
    
    // Update form fields
    selectedChildId.value = id;
    childNameInput.value = childName;
    parentNameInput.value = parentName;
    attendanceNotes.value = '';
    
    // Enable buttons
    if (signInButton) signInButton.disabled = false;
    if (signOutButton) signOutButton.disabled = false;
    
    // Clear search results
    if (searchResults) searchResults.innerHTML = '';
    if (searchInput) searchInput.value = childName;
    
    // Update the profile picture and get attendance status
    fetch(`{% url 'attendance:child_profile' %}?id=${id}`)
        .then(response => response.json())
        .then(data => {
            // Update the profile picture
            const profilePicture = document.getElementById('profilePicture');
            if (profilePicture) {
                profilePicture.src = data.profile_picture;
            }
            
            // Update the parent name
            if (parentNameInput) parentNameInput.value = data.parent_name;
            
            // Update the status display
            const statusElement = document.getElementById('attendanceStatus');
            if (statusElement) {
                let statusText = '';
                if (data.attendance_status) {
                    statusText = `${data.attendance_status}`;
                } else {
                    statusText = 'Not signed in today';
                }
                statusElement.textContent = statusText;
            }
        })
        .catch(error => {
            console.error('Error loading profile picture:', error);
            if (parentNameInput) parentNameInput.value = 'Error loading parent name';
        });
}

function toggleAttendanceType() {
    const attendanceType = document.getElementById('attendanceType');
    const attendanceTypeSelect = document.getElementById('attendanceTypeSelect');
    attendanceType.value = attendanceTypeSelect.value;
    
    // Update the submit button text based on attendance type
    const submitButton = document.querySelector('#attendanceForm button[type="submit"]');
    submitButton.textContent = attendanceTypeSelect.value === 'IN' ? 'Sign In' : 'Sign Out';
    
    // Update the form action URL to include the attendance type
    const form = document.getElementById('attendanceForm');
    if (form) {
        // Remove any existing type parameter
        form.action = form.action.split('?')[0];
        form.action += '?type=' + attendanceTypeSelect.value;
    }
}

// Helper function to escape HTML
function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize elements
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const form = document.getElementById('attendanceForm');
    const loadingIndicator = document.createElement('div');
    loadingIndicator.className = 'text-center mb-3';
    loadingIndicator.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';

    // Check if all elements exist
    if (!searchInput || !searchResults || !form) {
        console.error('Search elements not found');
        return;
    }

    // Handle form submission
    form.addEventListener('submit', function(e) {
        const actionInput = document.getElementById('attendanceAction');
        const submitButton = e.submitter;
        
        // Determine action based on which button was clicked
        if (submitButton && submitButton.id === 'signOutButton') {
            actionInput.value = 'sign_out';
        } else {
            actionInput.value = 'sign_in';
        }
    });

    // Search functionality
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        
        // Clear the parent input box when search starts
        const parentNameInput = document.getElementById('parentName');
        if (parentNameInput) {
            parentNameInput.value = '';
        }
        
        // Only search if term is at least 2 characters
        if (searchTerm.length >= 2) {
            searchResults.innerHTML = '';
            searchResults.appendChild(loadingIndicator);
            
            // Get CSRF token from cookie
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            const csrftoken = getCookie('csrftoken');
            
            fetch(`{% url 'attendance:search_children' %}?q=${encodeURIComponent(searchTerm)}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrftoken
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Search failed');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.length === 0) {
                        searchResults.innerHTML = '<div class="text-center text-muted">No results found</div>';
                    } else {
                        const resultsHtml = data.map(child => `
                            <div class="list-group-item list-group-item-action d-flex align-items-center" 
                               onclick="selectChild(${child.id}, '${escapeHtml(child.name)}', '${escapeHtml(child.parent__name)}')">
                                <div class="d-flex align-items-center">
                                    <img src="${child.profile_picture}" alt="${escapeHtml(child.name)}" 
                                         class="rounded-circle me-3" style="width: 40px; height: 40px; object-fit: cover;">
                                    <div>
                                        <h6 class="mb-1">${escapeHtml(child.name)}</h6>
                                        <small class="text-muted">${escapeHtml(child.parent__name)}</small>
                                        <small class="text-muted mt-1">
                                            <span class="attendance-status ${child.attendance_status ? 'd-block' : 'd-none'}">
                                                <i class="fas fa-circle me-1 ${child.attendance_status === 'Signed In' ? 'text-success' : 'text-danger'}"></i>
                                                ${child.attendance_status}
                                            </span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                        searchResults.innerHTML = resultsHtml;
                    }
                })
                .catch(error => {
                    searchResults.innerHTML = '<div class="text-center text-danger">Error searching: ' + error.message + '</div>';
                    console.error('Search error:', error);
                });
        } else {
            searchResults.innerHTML = '';
        }
    });
});
</script>
{% endblock %}
